resources:
  alerts:
    iot_anomaly_alert:
      display_name: "IoT Anomaly Detection Alert - ${workspace.current_user.short_name}"
      
      query_id: ${resources.queries.anomaly_count_query.id}
      
      # Alert when defects detected in last 10 minutes exceeds threshold
      condition:
        operand:
          column:
            name: defects_count
        op: GREATER_THAN
        threshold:
          value:
            double_value: 0
      
      # Start in muted state - users can unmute after validating setup
      state: MUTED
      
      # Email notification settings
      custom_subject: "IoT Defects Detected"
      custom_body: "The number of potential defects detected in the last 10 minutes exceeds the threshold. Please review the anomaly_detected table."
      
      # Notification destinations - update with your preferred channels
      # email_subscriptions:
      #   - ${workspace.current_user.user_name}

  queries:
    anomaly_count_query:
      display_name: "IoT Anomaly Count - ${workspace.current_user.short_name}"
      warehouse_id: ${var.warehouse_id}
      parent_path: ${workspace.file_path}/queries
      
      query_text: |
        SELECT count(*) as defects_count
        FROM ${var.catalog}.${var.schema}.anomaly_detected
        WHERE `timestamp` > current_timestamp() - INTERVAL 10 MINUTES

variables:
  warehouse_id:
    description: SQL Warehouse ID for alert queries
