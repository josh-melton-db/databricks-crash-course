bundle:
  name: iot_time_series_analysis

include:
  - resources/*.yml

variables:
  catalog:
    description: Unity Catalog catalog name
    default: default
  
  schema:
    description: Unity Catalog schema name for pipeline tables
    default: ${workspace.current_user.short_name}_iot_anomaly_detection

workspace:
  root_path: ~/.bundle/${bundle.name}/${bundle.target}

targets:
  dev:
    mode: development
    default: true
    workspace:
      host: ${workspace.host}
    
    resources:
      pipelines:
        iot_anomaly_detection_pipeline:
          name: iot_anomaly_detection_${workspace.current_user.short_name}
          target: ${var.schema}
          
          libraries:
            - file:
                path: ./src/bronze/sensor_bronze.py
            - file:
                path: ./src/bronze/inspection_bronze.py
            - file:
                path: ./src/silver/anomaly_detected.py
            - file:
                path: ./src/silver/inspection_silver.py
            - file:
                path: ./src/gold/inspection_gold.py
          
          catalog: ${var.catalog}
          
          configuration:
            catalog: ${var.catalog}
            schema: ${var.schema}
            pipelines.useV2DetailsApi: "true"
          
          clusters:
            - label: default
              autoscale:
                min_workers: 1
                max_workers: 2
                mode: ENHANCED
          
          channel: PREVIEW
          edition: ADVANCED
          photon: true
          continuous: false
          development: true
          
          notifications:
            - email_recipients:
                - ${workspace.current_user.user_name}
              alerts:
                - on-update-failure
                - on-update-fatal-failure
  
  prod:
    mode: production
    workspace:
      host: ${workspace.host}
      root_path: /Shared/.bundle/${bundle.name}/${bundle.target}
    
    resources:
      pipelines:
        iot_anomaly_detection_pipeline:
          name: iot_anomaly_detection_prod
          target: ${var.schema}
          
          libraries:
            - file:
                path: ./src/bronze/sensor_bronze.py
            - file:
                path: ./src/bronze/inspection_bronze.py
            - file:
                path: ./src/silver/anomaly_detected.py
            - file:
                path: ./src/silver/inspection_silver.py
            - file:
                path: ./src/gold/inspection_gold.py
          
          catalog: ${var.catalog}
          
          configuration:
            catalog: ${var.catalog}
            schema: ${var.schema}
            pipelines.useV2DetailsApi: "true"
          
          clusters:
            - label: default
              autoscale:
                min_workers: 2
                max_workers: 5
                mode: ENHANCED
          
          channel: CURRENT
          edition: ADVANCED
          photon: true
          continuous: false
          development: false
          
          notifications:
            - email_recipients:
                - ${workspace.current_user.user_name}
              alerts:
                - on-update-failure
                - on-update-fatal-failure
                - on-flow-failure
